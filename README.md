# Endjin.FreeAgent

A comprehensive .NET client library for the [FreeAgent](https://www.freeagent.com/) accounting API, providing strongly-typed access to all FreeAgent resources with modern C# features.

> Parts of this library have been generated by AI and may contain errors. Please raise an issue / submit a PR.

## Overview

`Endjin.FreeAgent` is a fully-featured .NET client library designed to simplify integration with the FreeAgent accounting platform. Built with .NET 10 and C# 14 preview features, it provides a type-safe, performant, and developer-friendly way to interact with FreeAgent's REST API.

## Architecture

The solution consists of two core packages:

- **[Endjin.FreeAgent.Client](./Solutions/Endjin.FreeAgent.Client)** - The main client library providing API operations and HTTP communication
- **[Endjin.FreeAgent.Domain](./Solutions/Endjin.FreeAgent.Domain)** - Domain models and types representing all FreeAgent resources

## Features

### Comprehensive API Coverage
- ‚úÖ **Invoicing** - Create, manage, and track sales invoices and recurring invoices
- ‚úÖ **Contacts** - Manage customers, suppliers, and other contacts
- ‚úÖ **Projects** - Track projects and their associated tasks
- ‚úÖ **Expenses** - Handle expense claims, receipts, and mileage tracking
- ‚úÖ **Banking** - Bank accounts, transactions, explanations, and statement uploads
- ‚úÖ **Time Tracking** - Timeslips and task management
- ‚úÖ **Bills** - Purchase bills and supplier invoices
- ‚úÖ **Credit Notes** - Refunds, corrections, and reconciliations
- ‚úÖ **Estimates** - Quotes and proposals
- ‚úÖ **Reports** - Trial Balance, Balance Sheet, P&L, Cash Flow, Final Accounts
- ‚úÖ **Tax Returns** - VAT, Corporation Tax, Self Assessment, CIS
- ‚úÖ **Payroll** - RTI payroll data and payroll profiles (UK)
- ‚úÖ **Assets** - Capital assets, depreciation profiles, and stock items
- ‚úÖ **Webhooks** - API event notifications
- ‚úÖ **Company Settings** - Company configuration and users

### Technical Features
- üöÄ **Modern .NET 10** - Built on the latest .NET runtime
- üìù **Strongly-Typed** - Full type safety with C# 14 records
- ‚ö° **High Performance** - System.Text.Json with source generation
- üîÑ **Async/Await** - Fully asynchronous operations
- üíæ **Built-in Caching** - Memory caching with 5-minute sliding expiration (24 hours for reference data)
- üîê **OAuth2 Support** - Complete authentication flow implementation with automatic token refresh
- üìä **Comprehensive Logging** - Integration with Microsoft.Extensions.Logging
- ‚ôªÔ∏è **Retry Logic** - Resilient HTTP operations with Corvus.Retry exponential backoff
- üß™ **Well-Tested** - Extensive test coverage with MSTest

## Getting Started

### Prerequisites

- .NET 10.0 or later
- A FreeAgent account with API access
- OAuth2 credentials (Client ID and Secret)

### Installation

Install the client library via NuGet:

```bash
dotnet add package Endjin.FreeAgent.Client
```

The domain package is automatically included as a dependency.

### Basic Usage

```csharp
using Endjin.FreeAgent.Client;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;

// Configure services
ServiceCollection services = new();
services.AddMemoryCache();
services.AddHttpClient();
services.AddLogging(builder => builder.AddConsole());

ServiceProvider serviceProvider = services.BuildServiceProvider();

// Configure client options
FreeAgentOptions options = new()
{
    ClientId = "your-client-id",
    ClientSecret = "your-client-secret",
    RefreshToken = "your-refresh-token",
    UseSandbox = false // Set to true for sandbox environment
};

// Create client
IMemoryCache cache = serviceProvider.GetRequiredService<IMemoryCache>();
IHttpClientFactory httpClientFactory = serviceProvider.GetRequiredService<IHttpClientFactory>();
ILoggerFactory loggerFactory = serviceProvider.GetRequiredService<ILoggerFactory>();

FreeAgentClient client = new(options, cache, httpClientFactory, loggerFactory);

// Use the client
IEnumerable<Invoice> invoices = await client.Invoices.GetAllAsync();
IEnumerable<Contact> contacts = await client.Contacts.GetAllActiveAsync();
```

#### Interactive Authentication

If you need to obtain a refresh token or support interactive user login:

```csharp
// Create client with interactive authentication
FreeAgentClient client = FreeAgentClient.CreateInteractive(
    clientId: "your-client-id",
    clientSecret: "your-client-secret",
    useSandbox: false,
    cache: cache,
    httpClientFactory: httpClientFactory,
    loggerFactory: loggerFactory);

// This will trigger the OAuth2 flow (opening browser, etc.) on first API call
IEnumerable<Invoice> invoices = await client.Invoices.GetAllAsync();
```

### Dependency Injection

The library provides extension methods for easy registration with `IServiceCollection`:

```csharp
// In Program.cs or Startup.cs
builder.Services.AddFreeAgentClientServices(builder.Configuration);
```

Ensure your configuration (e.g., `appsettings.json`) contains the `FreeAgent` section:

```json
{
  "FreeAgent": {
    "ClientId": "your-client-id",
    "ClientSecret": "your-client-secret",
    "RefreshToken": "your-refresh-token",
    "UseSandbox": false
  }
}
```

## Demo Application

The solution includes a CLI demo application (`DemoApp`) that showcases the library's capabilities. It uses [Spectre.Console](https://spectreconsole.net/) for a rich terminal experience.

### Running the Demo App

You can run the demo app from the command line. It supports both standard (configured) mode and interactive login mode.

#### Standard Mode (using configuration)

If you have your credentials configured in `appsettings.json` or User Secrets:

```bash
dotnet run --project Solutions/DemoApp/DemoApp.csproj
```

#### Interactive Login Mode

To log in interactively via OAuth2 (useful for obtaining your first Refresh Token):

```bash
dotnet run --project Solutions/DemoApp/DemoApp.csproj -- --interactive-login
```

Or using the short flag:

```bash
dotnet run --project Solutions/DemoApp/DemoApp.csproj -- -i
```

#### Sandbox Environment

To use the FreeAgent Sandbox environment:

```bash
dotnet run --project Solutions/DemoApp/DemoApp.csproj -- --sandbox
```

You can combine flags:

```bash
dotnet run --project Solutions/DemoApp/DemoApp.csproj -- -i -s
```

### Configuration for Demo App

You can configure the Demo App using User Secrets to avoid committing credentials:

```bash
dotnet user-secrets init --project Solutions/DemoApp/DemoApp.csproj
dotnet user-secrets set "FreeAgent:ClientId" "your-client-id" --project Solutions/DemoApp/DemoApp.csproj
dotnet user-secrets set "FreeAgent:ClientSecret" "your-client-secret" --project Solutions/DemoApp/DemoApp.csproj
dotnet user-secrets set "FreeAgent:RefreshToken" "your-refresh-token" --project Solutions/DemoApp/DemoApp.csproj
```

The demo app uses the UserSecretsId `FreeAgent.DemoApp`.

## Project Structure

```
Endjin.FreeAgent/
‚îú‚îÄ‚îÄ Solutions/
‚îÇ   ‚îú‚îÄ‚îÄ Endjin.FreeAgent.Client/         # Main client library
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Client/                      # API client implementations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Configuration/               # Client configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OAuth2/                      # Authentication logic
‚îÇ   ‚îú‚îÄ‚îÄ Endjin.FreeAgent.Domain/         # Domain models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Domain/                      # All FreeAgent resource models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Converters/                  # JSON converters for enums and custom types
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Validation/                  # Data validation classes
‚îÇ   ‚îú‚îÄ‚îÄ Endjin.FreeAgent.Client.Tests/   # Client unit tests
‚îÇ   ‚îú‚îÄ‚îÄ Endjin.FreeAgent.Domain.Tests/   # Domain unit tests
‚îÇ   ‚îî‚îÄ‚îÄ DemoApp/                         # Demo application
‚îú‚îÄ‚îÄ Docs/                                # FreeAgent API specifications
‚îî‚îÄ‚îÄ README.md                            # This file
```

## API Coverage

The client currently supports the following FreeAgent API endpoints:

| Resource                      | Operations                                              | Status     |
|-------------------------------|---------------------------------------------------------|------------|
| **Core Financial**            |                                                         |            |
| Invoices                      | Create, Read, Update, Delete, List, Email, Mark as Sent | ‚úÖ Complete |
| Recurring Invoices            | Read, List                                              | ‚úÖ Complete |
| Invoice Settings              | Read, Update                                            | ‚úÖ Complete |
| Estimates                     | Create, Read, Update, Delete, List, Send, Mark as Sent  | ‚úÖ Complete |
| Bills                         | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Credit Notes                  | Create, Read, Delete, List                              | ‚úÖ Complete |
| Credit Note Reconciliations   | Create, Read, Delete, List                              | ‚úÖ Complete |
| Expenses                      | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Mileages                      | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| **Banking**                   |                                                         |            |
| Bank Accounts                 | Read, List                                              | ‚úÖ Complete |
| Bank Transactions             | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Bank Transaction Explanations | Create, Read, Delete, List                              | ‚úÖ Complete |
| Bank Statement Uploads        | Create (OFX, QIF, CSV)                                  | ‚úÖ Complete |
| **Contacts & Projects**       |                                                         |            |
| Contacts                      | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Projects                      | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Tasks                         | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Timeslips                     | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| **Accounting**                |                                                         |            |
| Categories                    | List                                                    | ‚úÖ Complete |
| Journal Sets                  | Create, Read, Delete, List                              | ‚úÖ Complete |
| Transactions                  | Read, List                                              | ‚úÖ Complete |
| Opening Balances              | Read, Update                                            | ‚úÖ Complete |
| **Assets & Inventory**        |                                                         |            |
| Capital Assets                | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Capital Asset Types           | Read, List                                              | ‚úÖ Complete |
| Depreciation Profiles         | Read, List                                              | ‚úÖ Complete |
| Stock Items                   | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Price List Items              | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| **Reports**                   |                                                         |            |
| Trial Balance                 | Read (with summary entries)                             | ‚úÖ Complete |
| Balance Sheet                 | Read                                                    | ‚úÖ Complete |
| Profit & Loss                 | Read                                                    | ‚úÖ Complete |
| Cash Flow                     | Read                                                    | ‚úÖ Complete |
| Final Accounts                | Read                                                    | ‚úÖ Complete |
| Aged Debtors & Creditors      | Read                                                    | ‚úÖ Complete |
| **Tax**                       |                                                         |            |
| VAT Returns                   | Read, List, Update (payments)                           | ‚úÖ Complete |
| Sales Tax Periods             | Read, List                                              | ‚úÖ Complete |
| Sales Tax Rates               | List                                                    | ‚úÖ Complete |
| EC MOSS Sales Tax Rates       | List                                                    | ‚úÖ Complete |
| Corporation Tax Returns       | Read, List                                              | ‚úÖ Complete |
| Self Assessment Returns       | Read, List                                              | ‚úÖ Complete |
| CIS Bands                     | List (UK only)                                          | ‚úÖ Complete |
| **Payroll**                   |                                                         |            |
| Payroll                       | Read (UK RTI data)                                      | ‚úÖ Complete |
| Payroll Profiles              | Read, Update                                            | ‚úÖ Complete |
| **UK-Specific**               |                                                         |            |
| Hire Purchases                | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Properties                    | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| **Company & Users**           |                                                         |            |
| Company                       | Read, Update                                            | ‚úÖ Complete |
| Users                         | Read, List, Update                                      | ‚úÖ Complete |
| Email Addresses               | Read, List                                              | ‚úÖ Complete |
| **Other**                     |                                                         |            |
| Attachments                   | Create, Delete                                          | ‚úÖ Complete |
| Notes                         | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Webhooks                      | Create, Read, Delete, List                              | ‚úÖ Complete |

### Regional and Subscription-Specific Features

Some features are only available in specific regions or require certain FreeAgent subscription types:

- **UK-Only Features**: CIS Bands (Construction Industry Scheme), Hire Purchases, Properties (for unincorporated landlords), Payroll (RTI data)
- **EU-Specific Features**: EC MOSS Sales Tax Rates (Mini One Stop Shop)

## Contributing

We welcome contributions! Please see our contributing guidelines for details on:
- Code style and conventions
- Testing requirements
- Pull request process
- Issue reporting

### Development Requirements

- Visual Studio 2026 or later
- .NET 10 SDK
- Git

### Running Tests

The solution uses the Microsoft Testing Platform. You can run tests using `dotnet run`:

```bash
# Run client tests
dotnet run --project Solutions/Endjin.FreeAgent.Client.Tests/Endjin.FreeAgent.Client.Tests.csproj

# Run domain tests
dotnet run --project Solutions/Endjin.FreeAgent.Domain.Tests/Endjin.FreeAgent.Domain.Tests.csproj
```

## Performance Considerations

The client library is optimized for performance:

- **Source-Generated JSON** - Uses System.Text.Json source generation for minimal allocations
- **HTTP Client Factory** - Proper HttpClient lifecycle management
- **Memory Caching** - Built-in caching for frequently accessed resources
- **Async Throughout** - Non-blocking I/O operations
- **Minimal Dependencies** - Carefully selected, essential dependencies only

## Error Handling

The client provides comprehensive error handling:

```csharp
try
{
    Invoice invoice = await client.Invoices.GetAsync(invoiceId);
}
catch (HttpRequestException ex)
{
    // Handle network and API errors
    Console.WriteLine($"API Error: {ex.Message}");
    if (ex.StatusCode.HasValue)
    {
        Console.WriteLine($"Status Code: {ex.StatusCode}");
    }
}
```

## Support

For issues, feature requests, or questions:

- üêõ [Report an Issue](https://github.com/endjin/Endjin.FreeAgent/issues)
- üí¨ [Discussions](https://github.com/endjin/Endjin.FreeAgent/discussions)
- üìß Contact Endjin Limited

## License

See FreeAgent's [API Terms](https://dev.freeagent.com/docs/api_terms)

This project is licensed under the Apache License 2.0 - see the [LICENSE](LICENSE) file for details.

---

Copyright ¬© Endjin Limited. All rights reserved.
