# Endjin.FreeAgent

A comprehensive .NET client library for the [FreeAgent](https://www.freeagent.com/) accounting API, providing strongly-typed access to all FreeAgent resources with modern C# features.

> Parts of this library have been generated by AI and may contain errors. Please raise an issue / submit a PR.

## Overview

`Endjin.FreeAgent` is a fully-featured .NET client library designed to simplify integration with the FreeAgent accounting platform. Built with .NET 10 and C# 14 preview features, it provides a type-safe, performant, and developer-friendly way to interact with FreeAgent's REST API.

## Architecture

The solution consists of two core packages:

- **[Endjin.FreeAgent.Client](./Solutions/Endjin.FreeAgent.Client)** - The main client library providing API operations and HTTP communication
- **[Endjin.FreeAgent.Domain](./Solutions/Endjin.FreeAgent.Domain)** - Domain models and types representing all FreeAgent resources

## Features

### Comprehensive API Coverage
- ‚úÖ **Invoicing** - Create, manage, and track sales invoices and recurring invoices
- ‚úÖ **Contacts** - Manage customers, suppliers, and other contacts
- ‚úÖ **Projects** - Track projects and their associated tasks
- ‚úÖ **Expenses** - Handle expense claims, receipts, and mileage tracking
- ‚úÖ **Banking** - Bank accounts, transactions, explanations, and statement uploads
- ‚úÖ **Time Tracking** - Timeslips and task management
- ‚úÖ **Bills** - Purchase bills and supplier invoices
- ‚úÖ **Credit Notes** - Refunds, corrections, and reconciliations
- ‚úÖ **Estimates** - Quotes and proposals
- ‚úÖ **Reports** - Trial Balance, Balance Sheet, P&L, Cash Flow, Final Accounts
- ‚úÖ **Tax Returns** - VAT, Corporation Tax, Self Assessment, CIS
- ‚úÖ **Payroll** - RTI payroll data and payroll profiles (UK)
- ‚úÖ **Assets** - Capital assets, depreciation profiles, and stock items
- ‚úÖ **Webhooks** - API event notifications
- ‚úÖ **Company Settings** - Company configuration and users

### Technical Features
- üöÄ **Modern .NET 10** - Built on the latest .NET runtime
- üìù **Strongly-Typed** - Full type safety with C# 14 records
- ‚ö° **High Performance** - System.Text.Json with source generation
- üîÑ **Async/Await** - Fully asynchronous operations
- üíæ **Built-in Caching** - Memory caching with 5-minute sliding expiration (24 hours for reference data)
- üîê **OAuth2 Support** - Complete authentication flow implementation with automatic token refresh
- üìä **Comprehensive Logging** - Integration with Microsoft.Extensions.Logging
- ‚ôªÔ∏è **Retry Logic** - Resilient HTTP operations with Corvus.Retry exponential backoff
- üß™ **Well-Tested** - Extensive test coverage with MSTest

## Getting Started

### Prerequisites

- .NET 10.0 or later
- A FreeAgent account with API access
- OAuth2 credentials (Client ID and Secret)

### Installation

Install the client library via NuGet:

```bash
dotnet add package Endjin.FreeAgent.Client --version 1.0.0-preview.1
```

The domain package is automatically included as a dependency.

### Basic Usage

```csharp
using Endjin.FreeAgent.Client;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;

// Configure services
ServiceCollection services = new();
services.AddMemoryCache();
services.AddHttpClient();
services.AddLogging(builder => builder.AddConsole());

ServiceProvider serviceProvider = services.BuildServiceProvider();

// Configure client options
FreeAgentClientOptions options = new()
{
    ClientId = "your-client-id",
    ClientSecret = "your-client-secret",
    RefreshToken = "your-refresh-token",
    ApiUri = new Uri("https://api.freeagent.com/v2/")
};

// Create client
IMemoryCache cache = serviceProvider.GetRequiredService<IMemoryCache>();
IHttpClientFactory httpClientFactory = serviceProvider.GetRequiredService<IHttpClientFactory>();
ILoggerFactory loggerFactory = serviceProvider.GetRequiredService<ILoggerFactory>();

FreeAgentClient client = new(options, cache, httpClientFactory, loggerFactory);

// Use the client
IEnumerable<Invoice> invoices = await client.Invoices.GetAllAsync();
IEnumerable<Contact> contacts = await client.Contacts.GetAllActiveAsync();
IEnumerable<Project> projects = await client.Projects.GetAllActiveAsync();
```
## Sandbox Environment

FreeAgent provides a sandbox environment for development and testing. The sandbox allows you to build and test integrations without affecting real production data.

### Getting a Sandbox Account

1. **Create a Sandbox Account**
   - Visit [https://signup.sandbox.freeagent.com/signup](https://signup.sandbox.freeagent.com/signup)
   - Create a free temporary FreeAgent account
   - Complete the email confirmation process

2. **Complete Company Setup**
   - After signing in, complete all company setup stages
   - **Important**: Incomplete setup will cause unexpected API errors

3. **Create an App**
   - Go to [https://dev.freeagent.com/](https://dev.freeagent.com/)
   - Register your application
   - Note your OAuth identifier (Client ID) and OAuth secret (Client Secret)

### Sandbox API Endpoints

The sandbox uses different base URLs from production:

| Environment | API Base URL                            | Authorization Endpoint                             |
|-------------|-----------------------------------------|----------------------------------------------------|
| Sandbox     | `https://api.sandbox.freeagent.com/v2/` | `https://api.sandbox.freeagent.com/v2/approve_app` |
| Production  | `https://api.freeagent.com/v2/`         | `https://api.freeagent.com/v2/approve_app`         |

### Configuring the Client for Sandbox

Using the `UseSandbox` property (automatically sets the correct API base URL):

#### Interactive Login (Recommended for First-Time Setup)

The easiest way to obtain access and refresh tokens is to use the interactive login flow:

```csharp
using Endjin.FreeAgent.Client.OAuth2;
using Microsoft.Extensions.Logging;

// Configure OAuth2 options
OAuth2Options options = new()
{
    ClientId = "your-client-id",
    ClientSecret = "your-client-secret",
    UsePkce = true // Enable PKCE for enhanced security
};

// Create HTTP client and logger
using var httpClient = new HttpClient();
using var loggerFactory = LoggerFactory.Create(builder => builder.AddConsole());
var logger = loggerFactory.CreateLogger<InteractiveLoginHelper>();

// Create the interactive login helper
var loginHelper = new InteractiveLoginHelper(options, httpClient, logger);

// Perform interactive login
// This will open a browser window for authorization
InteractiveLoginResult result = await loginHelper.LoginAsync(redirectPort: 5000);

Console.WriteLine($"Access Token: {result.AccessToken}");
Console.WriteLine($"Refresh Token: {result.RefreshToken}");
Console.WriteLine($"Expires At: {result.ExpiresAt}");

// Save the refresh token for future use
```

The interactive login flow will:
1. Start a local HTTP listener on the specified port (default: 5000)
2. Open your browser to the FreeAgent authorization page
3. Wait for the OAuth callback with the authorization code
4. Automatically exchange the code for access and refresh tokens
5. Return the tokens for you to save and use

You can also use the DemoApp to perform interactive login:

```bash
cd Solutions/DemoApp
dotnet run -- --interactive-login
```

#### Manual OAuth2 Flow

For more control over the OAuth2 flow, you can use the OAuth2Service directly:

```csharp
// Initialize OAuth2 service
IOAuth2Service oauth2Service = new OAuth2Service(options, httpClient, cache, logger);

// Exchange authorization code for tokens
TokenResponse tokens = await oauth2Service.ExchangeAuthorizationCodeAsync(authorizationCode);

// Refresh access token when needed
string newAccessToken = await oauth2Service.RefreshAccessTokenAsync();
// Configure for sandbox environment
FreeAgentOptions options = new()
{
    ClientId = "your-sandbox-client-id",
    ClientSecret = "your-sandbox-client-secret",
    RefreshToken = "your-sandbox-refresh-token",
    UseSandbox = true
};

FreeAgentClient client = new(options, cache, httpClientFactory, loggerFactory);
```

Or using the constructor with explicit credentials:

```csharp
FreeAgentClient client = new(
    clientId,
    clientSecret,
    refreshToken,
    cache,
    httpClientFactory,
    loggerFactory,
    useSandbox: true);
```

Or via configuration:

```json
{
  "FreeAgent": {
    "ClientId": "your-sandbox-client-id",
    "ClientSecret": "your-sandbox-client-secret",
    "RefreshToken": "your-sandbox-refresh-token",
    "UseSandbox": true
  }
}
```

> **Note**: The `ApiBaseUrl` property is automatically computed based on `UseSandbox`. You don't need to specify the URL manually.

### Testing Rate Limits

The sandbox supports the same rate limits as production (120 requests/minute, 3600 requests/hour). To test your rate limit handling with artificially lowered limits (5 requests/minute), use the test header:

```bash
curl -H "X-RateLimit-Test: true" \
     -H "Authorization: Bearer {token}" \
     https://api.sandbox.freeagent.com/v2/company
```

### Sandbox Limitations

- **Trial Duration**: Sandbox accounts have a 30-day free trial (extensions available on request)
- **No Pre-populated Data**: You must create all test data manually
- **Periodic Resets**: Sandbox accounts may be periodically reset
- **No Production Sync**: Sandbox accounts are not linked to production accounts

### Best Practices

- Complete company setup before making API calls
- Use separate OAuth credentials for sandbox and production
- Test OAuth2 token refresh flows thoroughly
- Test error handling and rate limit back-off strategies
- Don't rely on persistent test data due to potential resets

## Building from Source

### Clone the Repository

```bash
git clone https://github.com/endjin/Endjin.FreeAgent.git
cd Endjin.FreeAgent
```

### Build the Solution

```bash
cd Solutions
dotnet build Endjin.FreeAgent.slnx
```

### Run Tests

```bash
dotnet test Endjin.FreeAgent.slnx
```

## Demo Application

The repository includes a comprehensive demo application showcasing various client features:

### Interactive Login Mode (Get Your First Tokens)

If you don't have a refresh token yet, use interactive login mode:

```bash
cd Solutions/DemoApp
dotnet run -- --interactive-login
# or
dotnet run -- -i
```

To use the **Sandbox** environment, add the `--sandbox` flag:

```bash
dotnet run -- --interactive-login --sandbox
# or
dotnet run -- -i -s
```

This will:
1. Open your browser to authorize the application with FreeAgent
2. Automatically receive and display your access and refresh tokens
3. Launch the interactive demo menu immediately

You only need ClientId and ClientSecret in your appsettings.json for this mode, or you can enter them when prompted.

### Standard Mode (Using Existing Refresh Token)

Once you have a refresh token configured, run the demo app normally:

```bash
cd Solutions/DemoApp
dotnet run
```

To run against the **Sandbox** environment in standard mode:

```bash
dotnet run -- --sandbox
```

You can also view help for the CLI:

```bash
dotnet run -- --help
```

The demo app demonstrates:
- Interactive OAuth2 authentication flow
- Token refresh and management
- Fetching and displaying various resources
- Creating and updating entities
- Error handling and retry logic
- **Rich CLI experience using Spectre.Console**

### Configuration

The demo app supports multiple configuration methods:

#### Option 1: appsettings.json

Create an `appsettings.json` file in the DemoApp directory:

For interactive login (first time):
```json
{
  "FreeAgent": {
    "ClientId": "your-client-id",
    "ClientSecret": "your-client-secret"
  }
}
```

For standard mode (with existing refresh token):
```json
{
  "FreeAgent": {
    "ClientId": "your-client-id",
    "ClientSecret": "your-client-secret",
    "RefreshToken": "your-refresh-token"
  }
}
```

#### Option 2: Environment Variables

Set the following environment variables:

```bash
# Linux/macOS
export FreeAgent__ClientId="your-client-id"
export FreeAgent__ClientSecret="your-client-secret"
export FreeAgent__RefreshToken="your-refresh-token"

# Windows (Command Prompt)
set FreeAgent__ClientId=your-client-id
set FreeAgent__ClientSecret=your-client-secret
set FreeAgent__RefreshToken=your-refresh-token

# Windows (PowerShell)
$env:FreeAgent__ClientId = "your-client-id"
$env:FreeAgent__ClientSecret = "your-client-secret"
$env:FreeAgent__RefreshToken = "your-refresh-token"
```

#### Option 3: User Secrets (Development)

For development, use .NET User Secrets to avoid storing credentials in source control:

```bash
cd Solutions/DemoApp
dotnet user-secrets set "FreeAgent:ClientId" "your-client-id"
dotnet user-secrets set "FreeAgent:ClientSecret" "your-client-secret"
dotnet user-secrets set "FreeAgent:RefreshToken" "your-refresh-token"
```

The demo app uses the UserSecretsId `FreeAgent.DemoApp`.

## Project Structure

```
Endjin.FreeAgent/
‚îú‚îÄ‚îÄ Solutions/
‚îÇ   ‚îú‚îÄ‚îÄ Endjin.FreeAgent.Client/         # Main client library
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Client/                      # API client implementations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Configuration/               # Client configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OAuth2/                      # Authentication logic
‚îÇ   ‚îú‚îÄ‚îÄ Endjin.FreeAgent.Domain/         # Domain models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Domain/                      # All FreeAgent resource models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Converters/                  # JSON converters for enums and custom types
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Validation/                  # Data validation classes
‚îÇ   ‚îú‚îÄ‚îÄ Endjin.FreeAgent.Client.Tests/   # Client unit tests
‚îÇ   ‚îú‚îÄ‚îÄ Endjin.FreeAgent.Domain.Tests/   # Domain unit tests
‚îÇ   ‚îî‚îÄ‚îÄ DemoApp/                         # Demo application
‚îú‚îÄ‚îÄ Docs/                                # FreeAgent API specifications
‚îî‚îÄ‚îÄ README.md                            # This file
```

## API Coverage

The client currently supports the following FreeAgent API endpoints:

| Resource                      | Operations                                              | Status     |
|-------------------------------|---------------------------------------------------------|------------|
| **Core Financial**            |                                                         |            |
| Invoices                      | Create, Read, Update, Delete, List, Email, Mark as Sent | ‚úÖ Complete |
| Recurring Invoices            | Read, List                                              | ‚úÖ Complete |
| Invoice Settings              | Read, Update                                            | ‚úÖ Complete |
| Estimates                     | Create, Read, Update, Delete, List, Send, Mark as Sent  | ‚úÖ Complete |
| Bills                         | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Credit Notes                  | Create, Read, Delete, List                              | ‚úÖ Complete |
| Credit Note Reconciliations   | Create, Read, Delete, List                              | ‚úÖ Complete |
| Expenses                      | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Mileages                      | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| **Banking**                   |                                                         |            |
| Bank Accounts                 | Read, List                                              | ‚úÖ Complete |
| Bank Transactions             | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Bank Transaction Explanations | Create, Read, Delete, List                              | ‚úÖ Complete |
| Bank Statement Uploads        | Create (OFX, QIF, CSV)                                  | ‚úÖ Complete |
| **Contacts & Projects**       |                                                         |            |
| Contacts                      | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Projects                      | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Tasks                         | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Timeslips                     | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| **Accounting**                |                                                         |            |
| Categories                    | List                                                    | ‚úÖ Complete |
| Journal Sets                  | Create, Read, Delete, List                              | ‚úÖ Complete |
| Transactions                  | Read, List                                              | ‚úÖ Complete |
| Opening Balances              | Read, Update                                            | ‚úÖ Complete |
| **Assets & Inventory**        |                                                         |            |
| Capital Assets                | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Capital Asset Types           | Read, List                                              | ‚úÖ Complete |
| Depreciation Profiles         | Read, List                                              | ‚úÖ Complete |
| Stock Items                   | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Price List Items              | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| **Reports**                   |                                                         |            |
| Trial Balance                 | Read (with summary entries)                             | ‚úÖ Complete |
| Balance Sheet                 | Read                                                    | ‚úÖ Complete |
| Profit & Loss                 | Read                                                    | ‚úÖ Complete |
| Cash Flow                     | Read                                                    | ‚úÖ Complete |
| Final Accounts                | Read                                                    | ‚úÖ Complete |
| Aged Debtors & Creditors      | Read                                                    | ‚úÖ Complete |
| **Tax**                       |                                                         |            |
| VAT Returns                   | Read, List, Update (payments)                           | ‚úÖ Complete |
| Sales Tax Periods             | Read, List                                              | ‚úÖ Complete |
| Sales Tax Rates               | List                                                    | ‚úÖ Complete |
| EC MOSS Sales Tax Rates       | List                                                    | ‚úÖ Complete |
| Corporation Tax Returns       | Read, List                                              | ‚úÖ Complete |
| Self Assessment Returns       | Read, List                                              | ‚úÖ Complete |
| CIS Bands                     | List (UK only)                                          | ‚úÖ Complete |
| **Payroll**                   |                                                         |            |
| Payroll                       | Read (UK RTI data)                                      | ‚úÖ Complete |
| Payroll Profiles              | Read, Update                                            | ‚úÖ Complete |
| **UK-Specific**               |                                                         |            |
| Hire Purchases                | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Properties                    | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| **Company & Users**           |                                                         |            |
| Company                       | Read, Update                                            | ‚úÖ Complete |
| Users                         | Read, List, Update                                      | ‚úÖ Complete |
| Email Addresses               | Read, List                                              | ‚úÖ Complete |
| **Other**                     |                                                         |            |
| Attachments                   | Create, Delete                                          | ‚úÖ Complete |
| Notes                         | Create, Read, Update, Delete, List                      | ‚úÖ Complete |
| Webhooks                      | Create, Read, Delete, List                              | ‚úÖ Complete |

### Regional and Subscription-Specific Features

Some features are only available in specific regions or require certain FreeAgent subscription types:

- **UK-Only Features**: CIS Bands (Construction Industry Scheme), Hire Purchases, Properties (for unincorporated landlords), Payroll (RTI data)
- **EU-Specific Features**: EC MOSS Sales Tax Rates (Mini One Stop Shop)

## Contributing

We welcome contributions! Please see our contributing guidelines for details on:
- Code style and conventions
- Testing requirements
- Pull request process
- Issue reporting

### Development Requirements

- Visual Studio 2022 Preview or later (for C# 14 support)
- .NET 10 SDK RC
- Git

### Running Tests

The solution includes comprehensive unit tests:

```bash
# Run all tests
dotnet test

# Run with coverage
dotnet test --collect:"XPlat Code Coverage"

# Run specific test project
dotnet test Endjin.FreeAgent.Client.Tests/Endjin.FreeAgent.Client.Tests.csproj
```

## Performance Considerations

The client library is optimized for performance:

- **Source-Generated JSON** - Uses System.Text.Json source generation for minimal allocations
- **HTTP Client Factory** - Proper HttpClient lifecycle management
- **Memory Caching** - Built-in caching for frequently accessed resources
- **Async Throughout** - Non-blocking I/O operations
- **Minimal Dependencies** - Carefully selected, essential dependencies only

## Error Handling

The client provides comprehensive error handling:

```csharp
try
{
    Invoice invoice = await client.Invoices.GetAsync(invoiceId);
}
catch (FreeAgentException ex)
{
    // Handle FreeAgent-specific errors
    Console.WriteLine($"FreeAgent error: {ex.Message}");
    Console.WriteLine($"Error code: {ex.ErrorCode}");
}
catch (HttpRequestException ex)
{
    // Handle network errors
    Console.WriteLine($"Network error: {ex.Message}");
}
```

## Support

For issues, feature requests, or questions:

- üêõ [Report an Issue](https://github.com/endjin/Endjin.FreeAgent/issues)
- üí¨ [Discussions](https://github.com/endjin/Endjin.FreeAgent/discussions)
- üìß Contact Endjin Limited

## License

See FreeAgent's [API Terms](https://dev.freeagent.com/docs/api_terms)

This project is licensed under the Apache License 2.0 - see the [LICENSE](LICENSE) file for details.

---

Copyright ¬© Endjin Limited. All rights reserved.